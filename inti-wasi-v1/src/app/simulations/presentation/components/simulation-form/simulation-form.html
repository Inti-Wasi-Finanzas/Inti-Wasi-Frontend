<form [formGroup]="form" (ngSubmit)="submit()" class="simulation-form">
  <h2 class="title-form">
    {{ isEditMode ? 'Editar simulación hipotecaria' : 'Simulación Hipotecaria' }}
  </h2>
  <h3>Datos del programa</h3>
  <div class="row">
    <mat-form-field>
      <mat-label>Programa</mat-label>
      <mat-select formControlName="programName">
        @for (p of programs; track p) {
          <mat-option [value]="p">{{ p }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Moneda</mat-label>
      <mat-select formControlName="currency">
        @for (c of currencies; track c) {
          <mat-option [value]="c">{{ c }}</mat-option>
        }
      </mat-select>
    </mat-form-field>
  </div>

  <h3>Datos del cliente</h3>
  <div class="row">
    <mat-form-field>
      <mat-label>Nombre completo</mat-label>
      <input matInput formControlName="fullName">
    </mat-form-field>

    <mat-form-field>
      <mat-label>DNI</mat-label>
      <input matInput formControlName="dni">
    </mat-form-field>
  </div>

  <div class="row">
    <mat-form-field>
      <mat-label>Fecha de nacimiento</mat-label>
      <input matInput type="date" formControlName="birthDate">
    </mat-form-field>

    <mat-form-field>
      <mat-label>Correo</mat-label>
      <input matInput formControlName="email">
    </mat-form-field>

    <mat-form-field>
      <mat-label>Teléfono</mat-label>
      <input matInput formControlName="phoneNumber">
    </mat-form-field>
  </div>

  <div class="row">
    <mat-form-field>
      <mat-label>Dirección</mat-label>
      <input matInput formControlName="address">
    </mat-form-field>

    <mat-form-field>
      <mat-label>Estado civil</mat-label>
      <mat-select formControlName="civilStatus">
        @for (cs of civilStatuses; track cs) {
          <mat-option [value]="cs">{{ cs }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Dependientes</mat-label>
      <input matInput type="number" formControlName="dependents">
    </mat-form-field>
  </div>

  <h3>Trabajo e ingresos</h3>
  <div class="row">
    <mat-form-field>
      <mat-label>Tipo de trabajo</mat-label>
      <mat-select formControlName="jobType">
        @for (jt of jobTypes; track jt) {
          <mat-option [value]="jt">{{ jt }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Meses en el trabajo</mat-label>
      <input matInput type="number" formControlName="jobMonths">
    </mat-form-field>

    <mat-form-field>
      <mat-label>Tipo de comprobante</mat-label>
      <mat-select formControlName="incomeProof">
        @for (ip of incomeProofs; track ip) {
          <mat-option [value]="ip">{{ ip }}</mat-option>
        }
      </mat-select>
    </mat-form-field>
  </div>

  <div class="row">
    <mat-form-field>
      <mat-label>Ingreso mensual</mat-label>
      <input matInput type="number" formControlName="monthlyIncome">
    </mat-form-field>

    <mat-form-field>
      <mat-label>Ingresos del cónyuge</mat-label>
      <input matInput type="number" formControlName="spouseIncomes">
    </mat-form-field>
  </div>

  <h3>Situación crediticia</h3>
  <div class="row">
    <mat-form-field>
      <mat-label>¿Tiene deudas actuales?</mat-label>
      <mat-select formControlName="hasCurrentDebt">
        <mat-option [value]="true">Sí</mat-option>
        <mat-option [value]="false">No</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Pago mensual total de deudas</mat-label>
      <input matInput type="number" formControlName="totalMonthlyDebtPayments">
    </mat-form-field>

    <mat-form-field>
      <mat-label>Registro negativo en SBS</mat-label>
      <mat-select formControlName="negativeRecordSbs">
        <mat-option [value]="true">Sí</mat-option>
        <mat-option [value]="false">No</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <h3>Otros inmuebles y bonos</h3>
  <div class="row">
    <mat-form-field>
      <mat-label>¿Tiene otra propiedad?</mat-label>
      <mat-select formControlName="hasOtherProperty">
        <mat-option [value]="true">Sí</mat-option>
        <mat-option [value]="false">No</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field>
      <mat-label>¿Recibió bono antes FMV?</mat-label>
      <mat-select formControlName="receivedBonoBeforeFMV">
        <mat-option [value]="true">Sí</mat-option>
        <mat-option [value]="false">No</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field>
      <mat-label>¿Inmueble sostenible?</mat-label>
      <mat-select formControlName="isPropertySustainable">
        <mat-option [value]="true">Sí</mat-option>
        <mat-option [value]="false">No</mat-option>
      </mat-select>
    </mat-form-field>
  </div>

  <h3>Propiedad</h3>
  <div class="row">
    <mat-form-field>
      <mat-label>Nombre del proyecto</mat-label>
      <input matInput formControlName="propertyName">
    </mat-form-field>

    <mat-form-field>
      <mat-label>Departamento</mat-label>
      <input matInput formControlName="propertyDepartment">
    </mat-form-field>

    <mat-form-field>
      <mat-label>Distrito</mat-label>
      <input matInput formControlName="propertyDistrict">
    </mat-form-field>
  </div>

  <div class="row">
    <mat-form-field>
      <mat-label>Ubicación</mat-label>
      <input matInput formControlName="propertyLocation">
    </mat-form-field>

    <mat-form-field>
      <mat-label>Tipo de propiedad</mat-label>
      <mat-select formControlName="propertyType">
        @for (pt of propertyTypes; track pt) {
          <mat-option [value]="pt">{{ pt }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Precio de la propiedad</mat-label>
      <input matInput type="number" formControlName="propertyPrice">
    </mat-form-field>
  </div>


  <h3>Cuota inicial y bono</h3>
  <div class="row">
    <mat-form-field>
      <mat-label>Tipo de bono</mat-label>
      <mat-select formControlName="typeBond">
        @for (tb of typeBonds; track tb) {
          <mat-option [value]="tb">{{ tb }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field>
      <mat-label>¿Tiene cuota inicial?</mat-label>
      <mat-select formControlName="hasDownPayment">
        <mat-option [value]="true">Sí</mat-option>
        <mat-option [value]="false">No</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field>
      <mat-label>% de cuota inicial</mat-label>
      <input matInput type="number" formControlName="percentageDownPayment">
    </mat-form-field>
  </div>

  <h3>Financiamiento</h3>
  <div class="row">
    <mat-form-field>
      <mat-label>Entidad financiera</mat-label>
      <mat-select formControlName="financialInstitution">
        @for (fi of financialInstitutions; track fi) {
          <mat-option [value]="fi">{{ fi }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Plazo (meses)</mat-label>
      <input matInput type="number" formControlName="deadlinesMonths">
    </mat-form-field>

    <mat-form-field>
      <mat-label>Tasa de interés (%)</mat-label>
      <input matInput type="number" formControlName="interestRate">
    </mat-form-field>
  </div>

  <div class="row">
    <mat-form-field>
      <mat-label>Tipo de tasa</mat-label>
      <input matInput formControlName="typeRate">
    </mat-form-field>

    <mat-form-field>
      <mat-label>Capitalización</mat-label>
      <mat-select formControlName="capitalization">
        @for (cap of capitalizations; track cap) {
          <mat-option [value]="cap">{{ cap }}</mat-option>
        }
      </mat-select>
    </mat-form-field>
  </div>

  <h3>Comisiones y seguros</h3>
  <div class="row">
    <mat-form-field>
      <mat-label>Comisiones mensuales</mat-label>
      <input matInput type="number" formControlName="monthlyCommissions">
    </mat-form-field>

    <mat-form-field>
      <mat-label>Tasa de seguro de desgravamen</mat-label>
      <input matInput type="number" formControlName="mortgageInsuranceRate">
    </mat-form-field>

    <mat-form-field>
      <mat-label>Seguro de inmueble</mat-label>
      <input matInput type="number" formControlName="propertyInsurance">
    </mat-form-field>
  </div>


  <h3>Gracia y fecha de pago</h3>
  <div class="row">
    <mat-form-field>
      <mat-label>Tipo de periodo de gracia</mat-label>
      <mat-select formControlName="gracePeriodType">
        @for (gt of graceTypes; track gt) {
          <mat-option [value]="gt">{{ gt }}</mat-option>
        }
      </mat-select>
    </mat-form-field>

    <mat-form-field>
      <mat-label>Meses de gracia</mat-label>
      <input matInput type="number" formControlName="gracePeriodMonths">
    </mat-form-field>

    <mat-form-field>
      <mat-label>Día de pago</mat-label>
      <input matInput type="date" formControlName="dayOfPayment">
    </mat-form-field>
  </div>

  <div class="actions">
    <button mat-raised-button class="my-btn" type="submit">
      {{ isEditMode ? 'Actualizar información' : 'Generar simulación' }}
    </button>
  </div>

  <!-- ERRORES DE NEGOCIO (a nivel de formulario) -->
  <div class="business-errors" *ngIf="form.errors as errs">
    <!-- 1. Condiciones generales -->
    <mat-error *ngIf="errs['underAge']">
      Debes ser mayor de {{ errs['underAge'].minAge }} años para solicitar el crédito.
    </mat-error>

    <mat-error *ngIf="errs['negativeSbs']">
      No puedes realizar la simulación porque tienes registro negativo en la SBS.
    </mat-error>

    <mat-error *ngIf="errs['hasOtherProperty']">
      No cumples la condición porque ya tienes otra propiedad a tu nombre.
    </mat-error>

    <mat-error *ngIf="errs['receivedBonoBeforeFMV']">
      No cumples la condición porque ya recibiste un bono habitacional antes (FMV).
    </mat-error>

    <mat-error *ngIf="errs['debtLimit']">
      Tus pagos mensuales de deudas superan el {{ (errs['debtLimit'].maxRatio * 100) | number:'1.0-0' }}%
      del ingreso familiar permitido.
    </mat-error>

    <!-- 2. Reglas para NUEVO CRÉDITO MIVIVIENDA -->
    <mat-error *ngIf="errs['mvPriceRange']">
      Para MiVivienda, el precio del inmueble debe estar entre
      S/ {{ errs['mvPriceRange'].min | number:'1.2-2' }} y
      S/ {{ errs['mvPriceRange'].max | number:'1.2-2' }}.
    </mat-error>

    <mat-error *ngIf="errs['mvIncomeTooLow']">
      Para MiVivienda, el ingreso familiar debe ser mayor a
      S/ {{ errs['mvIncomeTooLow'].minIncome | number:'1.2-2' }}.
    </mat-error>

    <mat-error *ngIf="errs['mvDownPaymentMin']">
      Para MiVivienda, la cuota inicial mínima es
      {{ errs['mvDownPaymentMin'].min | number:'1.1-1' }}% del valor del inmueble.
    </mat-error>

    <!-- 3. Reglas para TECHO PROPIO (generales) -->
    <mat-error *ngIf="errs['tpIncomeMax']">
      Para Techo Propio, el ingreso familiar no debe superar
      S/ {{ errs['tpIncomeMax'].maxIncome | number:'1.2-2' }}.
    </mat-error>

    <mat-error *ngIf="errs['tpPriceMax']">
      Para Techo Propio, el precio del inmueble no puede superar
      S/ {{ errs['tpPriceMax'].maxPrice | number:'1.2-2' }}.
    </mat-error>

    <!-- 4. Reglas específicas de rangos de precio / ingreso en Techo Propio -->
    <mat-error *ngIf="errs['tpLowPriceHighIncome']">
      Para inmuebles de hasta S/
      {{ errs['tpLowPriceHighIncome'].maxPriceForRange | number:'1.2-2' }},
      el ingreso familiar no puede ser mayor a
      S/ {{ errs['tpLowPriceHighIncome'].maxIncomeForRange | number:'1.2-2' }}.
    </mat-error>

    <mat-error *ngIf="errs['tpIncomeOutOfRange']">
      Para inmuebles mayores a S/
      {{ errs['tpIncomeOutOfRange'].minPrice | number:'1.2-2' }}
      y hasta S/
      {{ errs['tpIncomeOutOfRange'].maxPrice | number:'1.2-2' }},
      el ingreso familiar debe estar entre
      S/ {{ errs['tpIncomeOutOfRange'].minIncome | number:'1.2-2' }} y
      S/ {{ errs['tpIncomeOutOfRange'].maxIncome | number:'1.2-2' }}.
    </mat-error>

    <!-- 5. Techo Propio: VIS priorizada -->
    <mat-error *ngIf="errs['tpVisPriorizadaDownPayment']">
      Para Techo Propio VIS priorizada, la cuota inicial debe estar entre
      {{ errs['tpVisPriorizadaDownPayment'].min | number:'1.1-1' }}% y
      {{ errs['tpVisPriorizadaDownPayment'].max | number:'1.1-1' }}%
      del valor del inmueble.
    </mat-error>

    <!-- 6. Techo Propio: VIS regular -->
    <mat-error *ngIf="errs['tpVisRegularDownPayment']">
      Para Techo Propio VIS regular, la cuota inicial mínima es de
      {{ errs['tpVisRegularDownPayment'].min | number:'1.1-1' }}%.
    </mat-error>

  </div>


</form>
